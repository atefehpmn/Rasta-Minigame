<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>شبیه‌ساز دی لچ (مقیاس‌پذیر)</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #fff;
      font-family: "Vazirmatn", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .wrap {
      display: flex;
      flex-direction: row;
      gap: 20px;
      max-width: 1100px;
      width: 100%;
      padding: 10px;
    }
    .card {
      flex: 1 1 auto;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .card-head {
      padding: 8px;
      font-size: 1rem;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    .card-body {
      flex: 1;
      padding: 0;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-head">سلول دی لچ</div>
      <div class="card-body"><canvas id="schematic"></canvas></div>
    </div>
    <div class="card">
      <div class="card-head">نمودار زمانی</div>
      <div class="card-body"><canvas id="waveform"></canvas></div>
    </div>
  </div>

<script>
let enable = 0, D = 0, Q = 0;
let schematic = document.getElementById("schematic");
let waveform = document.getElementById("waveform");

let signals = { enable: [], D: [], Q: [] };

const BASE_W_SCHEM = 350, BASE_H_SCHEM = 240;
const BASE_W_WAVE = 600, BASE_H_WAVE = 200;

const hitboxes = {
  data:   {x:20, y:50,  w:40, h:40},
  enable: {x:20, y:110, w:40, h:40}
};

// store scale + offsets so both drawing and input use same transform
let schematicTransform = {s:1, ox:0, oy:0};

// ---------- helpers for scaling ----------
function setupContext(canvas, baseW, baseH, isSchematic=false) {
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  const ctx = canvas.getContext("2d");
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);

  const sx = rect.width / baseW;
  const sy = rect.height / baseH;
  const s = Math.min(sx, sy);
  const ox = (rect.width - baseW * s) / 2;
  const oy = (rect.height - baseH * s) / 2;

  ctx.translate(ox, oy);
  ctx.scale(s, s);

  if (isSchematic) {
    schematicTransform = {s, ox, oy, rect};
  }

  return ctx;
}

function getRelativeCoords(event, transform, baseW, baseH) {
  const rect = transform.rect;
  let clientX, clientY;
  if (event.touches && event.touches.length > 0) {
    clientX = event.touches[0].clientX;
    clientY = event.touches[0].clientY;
  } else {
    clientX = event.clientX;
    clientY = event.clientY;
  }

  const x = (clientX - rect.left - transform.ox) / transform.s;
  const y = (clientY - rect.top - transform.oy) / transform.s;
  return {x, y};
}

// ---------- schematic ----------
function drawSchematic() {
  const ctx = setupContext(schematic, BASE_W_SCHEM, BASE_H_SCHEM, true);
  ctx.clearRect(0, 0, BASE_W_SCHEM, BASE_H_SCHEM);
  ctx.lineWidth = 2;
  ctx.font = "18px Vazirmatn";

  // داده
  ctx.strokeStyle = "black";
  ctx.strokeRect(hitboxes.data.x, hitboxes.data.y, hitboxes.data.w, hitboxes.data.h);
  ctx.fillText("داده", 20, 40);
  ctx.fillStyle = D ? "limegreen" : "lightgray";
  ctx.fillRect(hitboxes.data.x, hitboxes.data.y, hitboxes.data.w, hitboxes.data.h);
  ctx.fillStyle = "black";
  ctx.fillText(D, 35, 77);

  // فعال‌ساز
  ctx.strokeStyle = "black";
  ctx.strokeRect(hitboxes.enable.x, hitboxes.enable.y, hitboxes.enable.w, hitboxes.enable.h);
  ctx.fillText("فعال‌ساز", 15, 170);
  ctx.fillStyle = enable ? "limegreen" : "lightgray";
  ctx.fillRect(hitboxes.enable.x, hitboxes.enable.y, hitboxes.enable.w, hitboxes.enable.h);
  ctx.fillStyle = "black";
  ctx.fillText(enable, 35, 137);

  // لچ
  ctx.strokeStyle = "black";
  ctx.strokeRect(100, 40, 120, 120);
  ctx.fillText("دی لچ", 140, 100);

  // خروجی
  ctx.strokeStyle = "blue";
  ctx.strokeRect(250, 80, 40, 40);
  ctx.fillStyle = "black";
  ctx.fillText(Q, 265, 107);
  ctx.fillText("خروجی", 240, 70);

  // wires
  ctx.strokeStyle = "green";
  ctx.beginPath();
  ctx.moveTo(60, 70); ctx.lineTo(100, 70);
  ctx.moveTo(60, 130); ctx.lineTo(100, 130);
  ctx.moveTo(220, 100); ctx.lineTo(250, 100);
  ctx.stroke();
}

function updateLatch() {
  if (enable === 1) Q = D;
  drawSchematic();
}

function handleInput(event) {
  const {x, y} = getRelativeCoords(event, schematicTransform, BASE_W_SCHEM, BASE_H_SCHEM);

  if (x >= hitboxes.data.x && x <= hitboxes.data.x + hitboxes.data.w &&
      y >= hitboxes.data.y && y <= hitboxes.data.y + hitboxes.data.h) {
    D = D ? 0 : 1;
  }
  if (x >= hitboxes.enable.x && x <= hitboxes.enable.x + hitboxes.enable.w &&
      y >= hitboxes.enable.y && y <= hitboxes.enable.y + hitboxes.enable.h) {
    enable = enable ? 0 : 1;
  }

  updateLatch();
  event.preventDefault?.();
}

schematic.addEventListener("click", handleInput);
schematic.addEventListener("touchstart", handleInput, { passive: false });

// ---------- waveforms ----------
function drawWaveforms() {
  const ctx = setupContext(waveform, BASE_W_WAVE, BASE_H_WAVE);
  ctx.clearRect(0, 0, BASE_W_WAVE, BASE_H_WAVE);

  ctx.fillStyle = "black";
  ctx.font = "18px Vazirmatn";
  ctx.fillText("داده", 10, 55);
  ctx.fillText("فعال‌ساز", 10, 105);
  ctx.fillText("خروجی", 10, 155);

  drawSignal(ctx, signals.D, 40, "red");
  drawSignal(ctx, signals.enable, 90, "blue");
  drawSignal(ctx, signals.Q, 140, "green");
}

function drawSignal(ctx, data, y, color) {
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    const x = i;
    const val = data[i];
    const level = val ? y - 20 : y;
    if (i === 0) ctx.moveTo(x, level);
    else ctx.lineTo(x, level);
  }
  ctx.stroke();
}

// ---------- loop ----------
function tick() {
  updateLatch();
  signals.enable.push(enable);
  signals.D.push(D);
  signals.Q.push(Q);
  if (signals.enable.length > BASE_W_WAVE) {
    signals.enable.shift();
    signals.D.shift();
    signals.Q.shift();
  }
  drawWaveforms();
  requestAnimationFrame(tick);
}

window.addEventListener("resize", () => {
  drawSchematic();
  drawWaveforms();
});

updateLatch();
drawWaveforms();
tick();
</script>
</body>
</html>