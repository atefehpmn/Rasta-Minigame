<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>شبیه‌ساز دی لچ (مقیاس‌پذیر)</title>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      background: #fff;
      font-family: "Vazirmatn", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .wrap {
      display: flex;
      flex-direction: row;
      gap: 20px;
      max-width: 1100px;
      width: 100%;
      padding: 10px;
    }
    .card {
      flex: 1 1 auto;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .card-head {
      padding: 8px;
      font-size: 1rem;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    .card-body {
      flex: 1;
      padding: 0;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: manipulation; /* allow taps */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="card-head">نمای نماد دی‌لچ</div>
      <div class="card-body"><canvas id="schematic"></canvas></div>
    </div>
    <div class="card">
      <div class="card-head">نمودار زمانی</div>
      <div class="card-body"><canvas id="waveform"></canvas></div>
    </div>
  </div>

<script>
let enable = 0, D = 0, Q = 0;
let schematic = document.getElementById("schematic");
let sctx = schematic.getContext("2d");
let waveform = document.getElementById("waveform");
let wctx = waveform.getContext("2d");

let signals = { enable: [], D: [], Q: [] };

const BASE_W_SCHEM = 350, BASE_H_SCHEM = 240;
const BASE_W_WAVE = 600, BASE_H_WAVE = 200;

// ---------- Resize & Scale ----------
function prepareContext(canvas, ctx, baseW, baseH) {
  const r = canvas.getBoundingClientRect();
  canvas.width = r.width;
  canvas.height = r.height;
  ctx.setTransform(1,0,0,1,0,0); // reset transform
  const sx = r.width / baseW;
  const sy = r.height / baseH;
  const s = Math.min(sx, sy);
  const ox = (r.width - baseW * s) / 2;
  const oy = (r.height - baseH * s) / 2;
  ctx.setTransform(s, 0, 0, s, ox, oy);
}

// ---------- schematic ----------
function drawSchematic() {
  prepareContext(schematic, sctx, BASE_W_SCHEM, BASE_H_SCHEM);
  sctx.clearRect(0, 0, BASE_W_SCHEM, BASE_H_SCHEM);

  sctx.lineWidth = 3;
  sctx.font = "18px Vazirmatn";

  // داده
  sctx.strokeStyle = "black";
  sctx.strokeRect(20, 50, 40, 40);
  sctx.fillText("داده", 20, 40);
  sctx.fillStyle = D ? "limegreen" : "lightgray";
  sctx.fillRect(20, 50, 40, 40);
  sctx.fillStyle = "black";
  sctx.fillText(D, 35, 77);

  // فعال‌ساز
  sctx.strokeStyle = "black";
  sctx.strokeRect(20, 110, 40, 40);
  sctx.fillText("فعال‌ساز", 15, 170);
  sctx.fillStyle = enable ? "limegreen" : "lightgray";
  sctx.fillRect(20, 110, 40, 40);
  sctx.fillStyle = "black";
  sctx.fillText(enable, 35, 137);

  // لچ
  sctx.strokeStyle = "black";
  sctx.strokeRect(100, 40, 120, 120);
  sctx.fillText("دی لچ", 140, 100);

  // خروجی
  sctx.strokeStyle = "blue";
  sctx.strokeRect(250, 80, 40, 40);
  sctx.fillStyle = "black";
  sctx.fillText(Q, 265, 107);
  sctx.fillText("خروجی", 240, 70);

  // wires
  sctx.strokeStyle = "green";
  sctx.beginPath();
  sctx.moveTo(60, 70); sctx.lineTo(100, 70);
  sctx.moveTo(60, 130); sctx.lineTo(100, 130);
  sctx.moveTo(220, 100); sctx.lineTo(250, 100);
  sctx.stroke();
}

// latch logic
function updateLatch() {
  if (enable === 1) Q = D;
  drawSchematic();
}

// ---------- Correct Click/Touch Mapping ----------
function getRelativeCoords(event, canvas, baseW, baseH) {
  const rect = canvas.getBoundingClientRect();
  const clientX = event.clientX ?? event.touches[0].clientX;
  const clientY = event.clientY ?? event.touches[0].clientY;
  const x = (clientX - rect.left) * (baseW / rect.width);
  const y = (clientY - rect.top) * (baseH / rect.height);
  return { x, y };
}

function handleInput(event) {
  const { x, y } = getRelativeCoords(event, schematic, BASE_W_SCHEM, BASE_H_SCHEM);
  if (x >= 20 && x <= 60 && y >= 50 && y <= 90) D = D ? 0 : 1;
  if (x >= 20 && x <= 60 && y >= 110 && y <= 150) enable = enable ? 0 : 1;
  updateLatch();
  event.preventDefault?.();
}

schematic.addEventListener("click", handleInput);
schematic.addEventListener("touchstart", handleInput, { passive: false });

// ---------- waveforms ----------
function drawWaveforms() {
  prepareContext(waveform, wctx, BASE_W_WAVE, BASE_H_WAVE);
  wctx.clearRect(0, 0, BASE_W_WAVE, BASE_H_WAVE);

  wctx.fillStyle = "black";
  wctx.font = "18px Vazirmatn";
  wctx.fillText("داده", 10, 55);
  wctx.fillText("فعال‌ساز", 10, 105);
  wctx.fillText("خروجی", 10, 155);

  drawSignal(signals.D, 40, "red");
  drawSignal(signals.enable, 90, "blue");
  drawSignal(signals.Q, 140, "green");
}

function drawSignal(data, y, color) {
  wctx.strokeStyle = color;
  wctx.lineWidth = 2.5;
  wctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    const x = i;
    const val = data[i];
    const level = val ? y - 20 : y;
    if (i === 0) wctx.moveTo(x, level);
    else wctx.lineTo(x, level);
  }
  wctx.stroke();
}

// ---------- loop ----------
function tick() {
  updateLatch();
  signals.enable.push(enable);
  signals.D.push(D);
  signals.Q.push(Q);
  if (signals.enable.length > BASE_W_WAVE) {
    signals.enable.shift();
    signals.D.shift();
    signals.Q.shift();
  }
  drawWaveforms();
  requestAnimationFrame(tick);
}

// redraw on resize (important in iframe!)
window.addEventListener("resize", () => {
  drawSchematic();
  drawWaveforms();
});

updateLatch();
drawWaveforms();
tick();
</script>
</body>
</html>
