<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>شبیه‌ساز دی لچ</title>
  <style>
    body {
      background: #fff;  /* white background */
      color: black;
      font-family: Tahoma, "Vazirmatn", "Sahel", sans-serif;
      display: flex;
      flex-direction: row;
      gap: 20px;
      padding: 20px;
    }
    canvas {
      background: #fff;
      border: 2px solid black;
    }
  </style>
</head>
<body>
  <canvas id="schematic" width="360" height="240"></canvas>
  <canvas id="waveform" width="600" height="200"></canvas>

<script>
let enable = 0;
let D = 0;
let Q = 0;

// schematic canvas
const schematic = document.getElementById("schematic");
const sctx = schematic.getContext("2d");

// waveform canvas
const canvas = document.getElementById("waveform");
const ctx = canvas.getContext("2d");

// signal history arrays
let signals = { enable: [], D: [], Q: [] };

// draw schematic (D latch block + clickable inputs)
function drawSchematic() {
  sctx.clearRect(0, 0, schematic.width, schematic.height);
  sctx.lineWidth = 2;
  sctx.font = "16px Tahoma";

  // --- داده (D) ---
  sctx.strokeStyle = "black";
  sctx.strokeRect(20, 50, 30, 30);
  sctx.fillText("داده", 20, 40);
  sctx.fillStyle = D ? "limegreen" : "lightgray";
  sctx.fillRect(20, 50, 30, 30);
  sctx.fillStyle = "black";
  sctx.fillText(D, 32, 72);

  // --- فعال‌ساز (Enable) ---
  sctx.strokeStyle = "black";
  sctx.strokeRect(20, 100, 30, 30);
  sctx.fillText("فعال‌ساز", 15, 145);
  sctx.fillStyle = enable ? "limegreen" : "lightgray";
  sctx.fillRect(20, 100, 30, 30);
  sctx.fillStyle = "black";
  sctx.fillText(enable, 32, 122);

  // --- لچ box (bigger) ---
  sctx.strokeStyle = "black";
  sctx.strokeRect(100, 40, 100, 100);   // bigger square
  sctx.fillText("دی لچ", 130, 90);

  // --- خروجی (Q), moved up ---
  sctx.strokeStyle = "blue";
  sctx.strokeRect(240, 70, 30, 30);
  sctx.fillStyle = "black";
  sctx.fillText(Q, 252, 92);
  sctx.fillText("خروجی", 235, 60);

  // --- Wires ---
  sctx.strokeStyle = "green";
  sctx.beginPath();
  // داده wire
  sctx.moveTo(50, 65); sctx.lineTo(100, 65); // straight into latch
  // فعال‌ساز wire
  sctx.moveTo(50, 115); sctx.lineTo(95, 115); 
  sctx.lineTo(100, 115); // connect into latch
  // خروجی wire
  sctx.moveTo(200, 90); sctx.lineTo(240, 90); // latch to Q
  sctx.stroke();

  // --- Draw small triangle arrow at Enable input ---
  sctx.fillStyle = "black";
  sctx.beginPath();
  sctx.moveTo(95, 110);  // left point
  sctx.lineTo(95, 120);  // bottom point
  sctx.lineTo(100, 115); // right point (towards latch)
  sctx.closePath();
  sctx.fill();
}

// latch logic
function updateLatch() {
  if (enable === 1) {
    Q = D;
  }
  drawSchematic();
}

// handle clicks on inputs
schematic.addEventListener("click", function(e) {
  const rect = schematic.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  // داده box
  if (x >= 20 && x <= 50 && y >= 50 && y <= 80) {
    D = D ? 0 : 1;
    updateLatch();
  }
  // فعال‌ساز box
  if (x >= 20 && x <= 50 && y >= 100 && y <= 130) {
    enable = enable ? 0 : 1;
    updateLatch();
  }
});

// draw waveforms
function drawWaveforms() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "black";
  ctx.font = "14px Tahoma";
  ctx.fillText("داده", 10, 40);
  ctx.fillText("فعال‌ساز", 10, 90);
  ctx.fillText("خروجی", 10, 140);

  drawSignal(signals.D, 40, "red");
  drawSignal(signals.enable, 90, "blue");
  drawSignal(signals.Q, 140, "green");
}

function drawSignal(data, y, color) {
  ctx.strokeStyle = color;
  ctx.beginPath();
  for (let i = 0; i < data.length; i++) {
    let x = i;
    let val = data[i];
    let level = val ? y - 20 : y;
    if (i === 0) {
      ctx.moveTo(x, level);
    } else {
      ctx.lineTo(x, level);
    }
  }
  ctx.stroke();
}

// live loop (smooth timing diagram)
function tick() {
  updateLatch();

  // push current values
  signals.enable.push(enable);
  signals.D.push(D);
  signals.Q.push(Q);

  // limit buffer size
  if (signals.enable.length > canvas.width) {
    signals.enable.shift();
    signals.D.shift();
    signals.Q.shift();
  }

  drawWaveforms();
  requestAnimationFrame(tick);
}

updateLatch();
tick();
</script>
</body>
</html>
